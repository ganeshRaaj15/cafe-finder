<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Café Finder</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class"
    }
  </script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { 
      position: absolute; 
      top: 0; left: 0; right: 0; bottom: 0; 
      z-index: 0; 
    }
    .leaflet-popup-content-wrapper { border-radius: 0.75rem; }

    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .glass {
      background: rgba(20, 20, 20, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

  <!-- Map -->
  <div id="map"></div>

  <!-- Sidebar (Glass, Floating) -->
  <aside class="absolute top-4 left-4 bottom-4 w-80 glass rounded-2xl shadow-xl flex flex-col overflow-hidden z-50">
    <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">☕ Café Finder</h1>
        <p class="text-sm text-gray-700 dark:text-gray-300">Find cafés near you or search an area</p>
      </div>
      <button id="themeToggle" 
              class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">
        🌞
      </button>
    </header>

    <!-- Search -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <input id="searchInput" 
             type="text" 
             placeholder="Enter a city or area..." 
             class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100"/>
      <button id="searchBtn" 
              class="mt-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-medium">
        🔍 Search
      </button>
      <button id="locateBtn" 
              class="mt-2 w-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 rounded-lg font-medium border border-gray-300 dark:border-gray-600">
        📍 Use My Location
      </button>
    </div>

    <!-- Results -->
    <div id="results" class="flex-1 overflow-y-auto p-4 space-y-3">
      <p class="text-gray-500 dark:text-gray-400 text-sm">Results will appear here...</p>
    </div>
  </aside>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const apiKey = "a82b424a45d84309ac686d0c83a3507a";

    // Map setup
    const map = L.map("map").setView([3.139, 101.6869], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    let markers = [];

    // Fetch cafes
    async function fetchCafes(bounds) {
      const url = `https://api.geoapify.com/v2/places?categories=catering.cafe&filter=rect:${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()},${bounds.getSouth()}&limit=20&apiKey=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.features || [];
    }

    // Render results
    function renderResults(cafes) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (!cafes.length) {
        resultsDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-sm">No cafés found.</p>`;
        return;
      }

      cafes.forEach(cafe => {
        const name = cafe.properties.name || "Unnamed Café";
        const addr = cafe.properties.formatted || "No address available";

        const div = document.createElement("div");
        div.className = "p-3 bg-white/70 dark:bg-gray-800/70 rounded-lg shadow hover:bg-white/90 dark:hover:bg-gray-700/80 cursor-pointer";
        div.innerHTML = `
          <h3 class="font-semibold text-indigo-700 dark:text-indigo-300">${name}</h3>
          <p class="text-sm text-gray-700 dark:text-gray-300">${addr}</p>
        `;
        div.onclick = () => {
          map.setView([cafe.geometry.coordinates[1], cafe.geometry.coordinates[0]], 16);
        };
        resultsDiv.appendChild(div);
      });
    }

    // Show cafes on map
    function showCafesOnMap(cafes) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      cafes.forEach(cafe => {
        const [lon, lat] = cafe.geometry.coordinates;
        const marker = L.marker([lat, lon]).addTo(map);
        marker.bindPopup(`<b>${cafe.properties.name || "Unnamed Café"}</b><br>${cafe.properties.formatted || ""}`);
        markers.push(marker);
      });
    }

    // Load cafes for current map view
    async function loadCafes() {
      const cafes = await fetchCafes(map.getBounds());
      renderResults(cafes);
      showCafesOnMap(cafes);
    }

    map.on("moveend", loadCafes);

    // Use current location
    document.getElementById("locateBtn").onclick = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 15);
          loadCafes();
        });
      }
    };

    // Search by area
    document.getElementById("searchBtn").onclick = async () => {
      const query = document.getElementById("searchInput").value;
      if (!query) return;

      const geocodeUrl = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(query)}&apiKey=${apiKey}`;
      const res = await fetch(geocodeUrl);
      const data = await res.json();

      if (data.features.length) {
        const { lat, lon } = data.features[0].properties;
        map.setView([lat, lon], 14);
        loadCafes();
      } else {
        alert("Area not found");
      }
    };

    // Theme toggle
    const themeBtn = document.getElementById("themeToggle");
    let darkMode = true;

    themeBtn.addEventListener("click", () => {
      darkMode = !darkMode;
      document.documentElement.classList.toggle("dark", darkMode);
      themeBtn.textContent = darkMode ? "🌞" : "🌙";
    });

    // Initial load
    loadCafes();
  </script>
</body>
</html>
